<div class="padding-h-lg padding-b-lg">
  <!-- Tags popup container -->
  <span class="tag-relative" #tag>
    <spot-tag
      [class.tag-bottom]="showTagBottom"
      #tagelem
      *ngIf="showTag"
      [name]="tagName"
      [postLink]="spot.link"
      (tag)="addTag($event)"
    ></spot-tag>
  </span>

  <!-- Add a comment -->
  <div *ngIf="spot.inRange && location">
    <div *ngIf="isAuthenticated$ | async; else auth">
      <div *ngIf="isVerified$ | async; else verify" class="col-center margin-t-lg">
        <div class="editor">
          <span
            #comment
            contenteditable="true"
            attr.ph="{{ 'MAIN.COMMENTS_CONTAINER.ADD_COMMENT_PLACEHOLDER' | translate }}"
            class="comment-content"
            (input)="onTextInput($event)"
            (keydown.enter)="onEnter()"
          ></span>
          <div class="image" *ngIf="imgSrc !== null">
            <img [src]="domSanitizer.bypassSecurityTrustUrl(imgSrc)" />
          </div>

          <div class="row-h-center flex-fill" *ngIf="imgSrc !== null">
            <span class="margin-h-md"> {{ 'MAIN.COMMENTS_CONTAINER.FILE_TITLE' | translate }} </span>
            <span class=""> {{ imageFile.name }} </span>
            <span class="text-secondary-highlight" (click)="removeFile()">
              <span class="material-icons"> delete </span>
            </span>
          </div>

          <div class="comment-options">
            <span
              class="text-secondary margin-r-sm"
              [class.text-error]="invalidLength()"
            >
              {{ COMMENT_CONSTANTS.MAX_CONTENT_LENGTH - currentLength }}
            </span>
            <input
              style="display: none"
              type="file"
              (change)="onFileChanged($event)"
              #fileInput
            />
            <span class="material-icons icon-secondary-highlight margin-r-sm" (click)="fileInput.click()">
              insert_photo
            </span>
            <span class="loading" *ngIf="addCommentLoading; else showsend">
              <spot-spinner size="small" light="true"> </spot-spinner>
            </span>
            <ng-template #showsend>
              <span class="send" (click)="addComment()">
                <i class="material-icons"> send </i>
              </span>
            </ng-template>
          </div>
        </div>
      </div>
      <ng-template #verify>
        <div class="auth-message">
          <i style="visibility: hidden" class="material-icons icon"> send </i>
          <span *ngIf="user.role !== 'GUEST'; else guest" class="text">
            {{ 'MAIN.COMMENTS_CONTAINER.VERIFY' | translate }}
          </span>
          <ng-template #guest>
            <span class="text"> {{ 'MAIN.COMMENTS_CONTAINER.GUEST' | translate }} </span>
          </ng-template>
          <i class="material-icons icon"> send </i>
        </div>
      </ng-template>
    </div>
    <ng-template #auth>
      <div class="auth-message">
        <i style="visibility: hidden" class="material-icons icon"> send </i>
        <span class="text"> {{ 'MAIN.COMMENTS_CONTAINER.LOGIN' | translate }} </span>
        <i class="material-icons icon"> send </i>
      </div>
    </ng-template>
  </div>

  <span *ngIf="addCommentError" class="row border-box padding-t-sm text-error background-container">
    {{ addCommentError }}
  </span>

  <!-- Load Recent/Refresh comments -->
  <div class="col background-container">
    <div class="row-center relative margin-t-md">
      <div
        *ngIf="totalCommentsAfter > 0; else refresh"
        class="relative"
      >
        <span (click)="loadRecentComments()" class="text-secondary-highlight">
          {{ 'MAIN.COMMENTS_CONTAINER.LOAD' | translate }}
          {{ loadRecentCommentsNum() }}
          {{
            loadRecentCommentsNum() > 1
              ? STRINGS.RECENT_COMMENTS
              : STRINGS.RECENT_COMMENTS_SINGULAR
          }}
        </span>
        <div *ngIf="loadingCommentsAfter" class="load-recent-loading">
          <spot-spinner size="small"></spot-spinner>
        </div>
      </div>
      <ng-template #refresh>
        <span class="relative full-width row-h-center justify-content-between">
          <!-- Dummy element to help position elements, is always visibilty: hidden -->
          <span class="load-recent-dummy">
            <span class="material-icons icon-secondary-highlight icon-sm"> refresh </span>
          </span>
          <span
            class="load-recent-hidden text-sm text-secondary"
            [class.load-recent-show]="refreshed"
          >
            Comments are up to date
          </span>
          <span (click)="loadRecentComments()">
            <span class="material-icons icon-secondary-highlight icon-sm"> refresh </span>
          </span>
        </span>
      </ng-template>
    </div>

    <!-- Comments -->
    <div *ngIf="comments.length > 0; else noComments">
      <div *ngFor="let comment of comments">
        <spot-comment
          [comment]="comment"
          [spot]="spot"
          [detailed]="detailed"
        ></spot-comment>
      </div>
    </div>
    <ng-template #noComments>
      <div *ngIf="loadingCommentsBefore; else none" class="col-center">
        <div *ngIf="showLoadingCommentsIndicator$ | async">
          <span> {{ 'MAIN.COMMENTS_CONTAINER.LOADING_COMMENTS' | translate }} </span>
          <div *ngIf="loadingCommentsBefore" class="margin-lg">
            <spot-spinner size="small" type="dot"></spot-spinner>
          </div>
        </div>
      </div>
      <ng-template #none>
        <div class="row-center margin-t-md">
          <span class="material-icons margin-r-md margin-t-sm icon-sm"> chat </span>
          <span class="text-sm">{{ 'MAIN.COMMENTS_CONTAINER.NO_COMMENTS' | translate }}</span>
        </div>
      </ng-template>
    </ng-template>

    <!-- Load More -->
    <div class="row-center padding-b-md" *ngIf="totalCommentsBefore > 0">
      <div class="relative row-v-center text-secondary-highlight margin-r-md" (click)="loadMoreComments()">
        {{ 'MAIN.COMMENTS_CONTAINER.LOAD' | translate }}
        {{ loadMoreCommentsNum() }}
        {{
          loadMoreCommentsNum() > 1
            ? STRINGS.MORE_COMMENTS
            : STRINGS.MORE_COMMENTS_SINGULAR
        }}
      </div>
      <div *ngIf="loadingCommentsBefore" class="load-comments-before">
        <spot-spinner size="small"></spot-spinner>
      </div>
    </div>
  </div>

  <div
    *ngIf="
      comments.length >= 5 &&
      (isAuthenticated$ | async) &&
      (isVerified$ | async) &&
      spot.inRange &&
      location
    "
    class="margin-t-md text-secondary-highlight"
    (click)="scrollToComment()"
  >
    {{ 'MAIN.COMMENTS_CONTAINER.MAKE_COMMENT' | translate }}
  </div>
</div>
