<div class="container">
  <div
    class="comment"
    [ngClass]="{ linked: post.startCommentLink === comment.link }"
  >
    <div class="left-bar">
      <div class="left-bar-alignment">
        <div class="column">
          <i
            class="material-icons vote"
            (click)="like()"
            [ngClass]="{ highlight: comment.rated === 1 }"
          >
            keyboard_arrow_up
          </i>
          <div class="points">{{ comment.likes - comment.dislikes }}</div>
          <i
            class="material-icons vote"
            (click)="dislike()"
            [ngClass]="{ highlight: comment.rated === 0 }"
          >
            keyboard_arrow_down
          </i>
        </div>

        <div
          [class]="getProfilePictureClass(comment.profilePicture)"
          [ngClass]="{ 'profile-owned': comment.owned }"
        >
          <img
            [src]="
              '../../../../../assets/images/profile/' +
              comment.profilePictureSrc
            "
          />
        </div>
      </div>
    </div>

    <div class="add-wrapper">
      <div class="content">
        <div class="tagger" *ngIf="comment.tag.tagged">
          <span class="highlight"> {{ comment.tag.tagger }} </span>
          {{ 'MAIN.COMMENTS.TAGGER' | translate }}
        </div>

        <div class="text">
          <span #text class="text-content"></span>
          <span *ngIf="isExpandable">
            <span *ngIf="expanded; else notExpanded">
              <span class="expand" (click)="setExpanded(false)">
                {{ 'MAIN.COMMENTS.SEE_LESS' | translate }}
              </span>
            </span>
            <ng-template #notExpanded>
              <span class="expand" (click)="setExpanded(true)">
                {{ 'MAIN.COMMENTS.SEE_MORE' | translate }}
              </span>
            </ng-template>
          </span>
        </div>

        <div *ngIf="accountMetadata$ | async as accountMetadata">
          <div
            *ngIf="comment.image_src !== null"
            (click)="imageClicked()"
            class="image"
          >
            <img
              [src]="comment.image_src"
              [ngClass]="{
                'image-blur': imageBlurred && accountMetadata.mature_filter
              }"
            />
            <div
              *ngIf="imageBlurred && accountMetadata.mature_filter"
              class="image-blur-text"
            >
              <span class="material-icons icon"> error_outline </span>
              <span class="text">
                {{ 'MAIN.COMMENTS.MATURE_CONTENT' | translate }}
              </span>
              <span class="text highlight">
                {{ 'MAIN.COMMENTS.MATURE_CONTENT_SHOW' | translate }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <div [hidden]="!showAddReply" class="add">
        <div class="editor">
          <span
            #reply
            contenteditable="true"
            attr.ph="{{ 'MAIN.COMMENTS.ADD_REPLY_PLACEHOLDER' | translate }}"
            class="reply-content"
            (input)="onTextInput($event)"
            (keydown.enter)="onEnter()"
          ></span>
          <div *ngIf="imgSrc !== null" class="image">
            <img [src]="domSanitizer.bypassSecurityTrustUrl(imgSrc)" />
          </div>
          <div class="file-options" *ngIf="imgSrc !== null">
            <span class="file-title">
              {{ 'MAIN.COMMENTS.FILE_TITLE' | translate }}
            </span>
            <span class="file-name">
              {{ getDisplayFilename(imageFile.name) }}
            </span>
            <span class="file-remove" (click)="removeFile()">
              <i class="material-icons"> delete </i>
            </span>
          </div>
          <div class="comment-options">
            <span
              class="counter"
              [ngClass]="{ 'counter-error': invalidLength() }"
            >
              {{ MAX_COMMENT_LENGTH - currentLength }}
            </span>
            <input
              style="display: none"
              type="file"
              (change)="onFileChanged($event)"
              #fileInput
            />
            <i class="material-icons photo" (click)="fileInput.click()">
              insert_photo
            </i>
            <span class="loading" *ngIf="addReplyLoading; else showsend">
              <spot-spinner size="small" light="true"> </spot-spinner>
            </span>
            <ng-template #showsend>
              <span class="send" (click)="addReply()">
                <i class="material-icons"> send </i>
              </span>
            </ng-template>
          </div>
        </div>
      </div>
      <div class="error" *ngIf="addReplyError">
        {{ addReplyError }}
      </div>
    </div>

    <div class="right-bar">
      <div #options>
        <i class="material-icons icon-size" (click)="setOptions(true)">
          more_horiz
        </i>
        <div class="dropdown align-bottom">
          <div class="dropdown-content" [ngClass]="{ show: optionsEnabled }">
            <div
              class="button"
              (click)="openReportModal(comment.post_id, comment.id)"
            >
              <span class="material-icons icon"> outlined_flag </span>
              {{ 'MAIN.COMMENTS.REPORT' | translate }}
            </div>
            <div
              class="button"
              (click)="
                openShareModal(post.id, post.link, comment.id, comment.link)
              "
            >
              <span class="material-icons icon"> share </span>
              {{ 'MAIN.COMMENTS.SHARE' | translate }}
            </div>
            <div
              *ngIf="
                comment.owned ||
                account.role === 'admin' ||
                account.role === 'owner'
              "
              class="button"
              (click)="deleteComment()"
            >
              <span class="material-icons icon"> delete </span>
              {{ 'MAIN.COMMENTS.DELETE' | translate }}
            </div>
          </div>
        </div>
      </div>
      <div class="time">
        {{ timeMessage }}
      </div>
      <div
        class="reply"
        (click)="setShowAddReply(true)"
        [ngClass]="{
          disabled: !(
            comment.tag.tagged ||
            (post.inRange &&
              (isAuthenticated$ | async) &&
              (isVerified$ | async) &&
              location)
          )
        }"
      >
        <i class="material-icons"> reply </i>
      </div>
    </div>
  </div>

  <span class="tag-relative" #tag>
    <spot-tag
      #tagelem
      *ngIf="showTag"
      [name]="tagName"
      [postLink]="post.link"
      (tag)="addTag($event)"
    ></spot-tag>
  </span>

  <div *ngIf="loadingReplies; else loadedReplies">
    <div
      *ngIf="showLoadingRepliesIndicator$ | async"
      class="no-replies-loading"
    >
      <span> {{ 'MAIN.COMMENTS.LOADING_REPLIES' | translate }} </span>
      <div class="loading">
        <spot-spinner size="small" type="dot"></spot-spinner>
      </div>
    </div>
  </div>
  <ng-template #loadedReplies>
    <div *ngFor="let reply of replies">
      <spot-reply
        [reply]="reply"
        [comment]="comment"
        [post]="post"
        [detailed]="detailed"
      ></spot-reply>
    </div>
  </ng-template>

  <div *ngIf="totalRepliesAfter > 0" class="load-more-container">
    <div class="load-more" (click)="loadMoreReplies()">
      {{ 'MAIN.COMMENTS.LOAD' | translate }}
      {{ loadMoreRepliesNum() }}
      {{
        loadMoreRepliesNum() > 1
          ? STRINGS.MORE_REPLIES
          : STRINGS.MORE_REPLIES_SINGULAR
      }}
      <div *ngIf="loadingMoreReplies" class="load-more-replies">
        <spot-spinner size="small"></spot-spinner>
      </div>
    </div>
  </div>
</div>
