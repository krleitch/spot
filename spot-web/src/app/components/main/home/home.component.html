<spot-main-nav (titleEvent)="refresh()"></spot-main-nav>

<!-- Location -->
<div class="locationToggle desktop">
  <div
    class="local"
    [ngClass]="{ selectedLocation: isSelectedLocation(eLocationType.LOCAL) }"
    (click)="setLocal()"
  >
    <i class="material-icons icon"> home </i>
  </div>
  <div
    class="global"
    [ngClass]="{ selectedLocation: isSelectedLocation(eLocationType.GLOBAL) }"
    (click)="setGlobal()"
  >
    <i class="material-icons icon"> public </i>
  </div>
</div>
<div #mobiledropdownlocation class="locationToggleMobile mobile">
  <div class="mobile-dropdown-container" (click)="dropdownLocation(true)">
    <i *ngIf="isSelectedLocation(eLocationType.LOCAL)" class="material-icons">
      home
    </i>
    <i *ngIf="isSelectedLocation(eLocationType.GLOBAL)" class="material-icons">
      public
    </i>
    <span class="material-icons"> expand_more </span>
  </div>
  <div class="dropdown">
    <div
      class="dropdown-content-location"
      [ngClass]="{ show: dropdownLocationEnabled }"
    >
      <div
        class="button"
        [ngClass]="{
          'selected-highlight': isSelectedLocation(eLocationType.LOCAL)
        }"
        (click)="setLocal()"
      >
        <i class="material-icons dropdown-icon"> home </i>
      </div>
      <div
        class="button"
        [ngClass]="{
          'selected-highlight': isSelectedLocation(eLocationType.GLOBAL)
        }"
        (click)="setGlobal()"
      >
        <i class="material-icons dropdown-icon"> public </i>
      </div>
    </div>
  </div>
</div>

<!-- Sort -->
<div class="postFilterToggle desktop">
  <div
    class="hot"
    [ngClass]="{ selectedSort: isSelectedSpotSort(eSearchType.HOT) }"
    (click)="setHot()"
  >
    <span class="material-icons icon"> rocket_launch </span>
    {{ 'MAIN.HOME.HOT' | translate }}
  </div>
  <div
    class="new"
    [ngClass]="{ selectedSort: isSelectedSpotSort(eSearchType.NEW) }"
    (click)="setNew()"
  >
    <span class="material-icons icon"> local_florist </span>
    {{ 'MAIN.HOME.NEW' | translate }}
  </div>
</div>
<div #mobiledropdownsort class="postFilterToggleMobile mobile">
  <div class="mobile-dropdown-container" (click)="dropdownSort(true)">
    <div *ngIf="isSelectedSpotSort(eSearchType.HOT)">
      {{ 'MAIN.HOME.HOT' | translate }}
    </div>
    <div *ngIf="isSelectedSpotSort(eSearchType.NEW)">
      {{ 'MAIN.HOME.NEW' | translate }}
    </div>
    <span class="material-icons"> expand_more </span>
  </div>
  <div class="dropdown">
    <div
      class="dropdown-content-sort"
      [ngClass]="{ show: dropdownSortEnabled }"
    >
      <div
        class="button"
        [ngClass]="{
          'selected-highlight': isSelectedSpotSort(eSearchType.HOT)
        }"
        (click)="setHot()"
      >
        {{ 'MAIN.HOME.HOT' | translate }}
      </div>
      <div
        class="button"
        [ngClass]="{
          'selected-highlight': isSelectedSpotSort(eSearchType.NEW)
        }"
        (click)="setNew()"
      >
        {{ 'MAIN.HOME.NEW' | translate }}
      </div>
    </div>
  </div>
</div>

<div class="container">
  <!-- If we need to prompt for location, show this first -->
  <div
    *ngIf="locationFailure !== 'prompt' || bypassLocation; else prompt"
    class="fit-container"
  >
    <!-- Don't show anything until we get the metadata -->
    <div *ngIf="locationType && searchType" class="fit-container">
      <!-- Determine if we need location -->
      <div
        *ngIf="
          location || locationType === eLocationType.GLOBAL;
          else noLocation
        "
        class="content"
      >
        <div *ngIf="user" class="fit-container">
          <!-- You still need location -->
          <div *ngIf="location; else createlocation" class="fit-container">
            <div
              *ngIf="user.role !== eUserRole.GUEST; else guest"
              class="fit-container"
            >
              <!-- Need a verified user -->
              <spot-create
                *ngIf="user.verifiedAt !== null; else verify"
              ></spot-create>
              <ng-template #verify>
                <div class="info-container">
                  <span class="material-icons icon"> email </span>
                  <div *ngIf="user.email; else noEmail">
                    <span class="text">
                      {{ 'MAIN.HOME.VERIFY' | translate }}
                    </span>
                    <div *ngIf="verificationSent === false; else sentverify">
                      <div class="text clickable" (click)="verifyUser()">
                        {{ 'MAIN.HOME.VERIFY_SEND' | translate }}
                      </div>
                      <span class="small-text">
                        {{ user.email }} (
                        <a
                          class="clickable small-text"
                          [routerLink]="'/account'"
                        >
                          Change Email
                        </a>
                        )
                      </span>
                    </div>
                    <ng-template #sentverify>
                      <span class="small-text">
                        {{ 'MAIN.HOME.VERIFY_SENT' | translate }}
                        {{ user.email }}
                      </span>
                    </ng-template>
                  </div>
                  <ng-template #noEmail>
                    <span class="text">
                      {{ 'MAIN.HOME.NO_EMAIL' | translate }}
                    </span>
                    <span class="small-text">
                      <a class="clickable small-text" [routerLink]="'/account'">
                        {{ 'MAIN.HOME.ADD_EMAIL' | translate }}
                      </a>
                    </span>
                  </ng-template>
                </div>
              </ng-template>
            </div>
            <ng-template #guest>
              <div class="info-container">
                <span class="material-icons icon"> account_circle </span>
                <div class="text">
                  {{ 'MAIN.HOME.GUEST' | translate }}
                </div>
              </div>
            </ng-template>
          </div>

          <!-- You need Location -->
          <ng-template #createlocation>
            <!-- location is still loading -->
            <div
              *ngIf="
                locationLoading && (showLocationIndicator$ | async);
                else enableLocationCreate
              "
              class="info-container"
            >
              <spot-spinner type="dot"></spot-spinner>
              <span class="text">
                {{ 'MAIN.HOME.LOADING_LOCATION' | translate }}
              </span>
              <span
                *ngIf="bypassLocation === true; else loadglobalblock"
                class="text"
              >
                {{ 'MAIN.HOME.LOCATION_REQUIRED' | translate }}
              </span>
              <ng-template #loadglobalblock>
                <span class="text clickable" (click)="loadLocationBackground()">
                  {{ 'MAIN.HOME.LOCATION_BACKGROUND_1' | translate }}
                  <i class="material-icons inline-icon"> public </i>
                  {{ 'MAIN.HOME.LOCATION_BACKGROUND_2' | translate }}
                </span>
              </ng-template>
            </div>
            <ng-template #enableLocationCreate>
              <!-- location is not enabled -->
              <div *ngIf="locationFailure === 'browser'" class="info-container">
                <span class="material-icons icon"> location_off </span>
                <span class="text">
                  {{ 'MAIN.HOME.LOCATION_BROWSER' | translate }}</span
                >
              </div>
              <div
                *ngIf="
                  locationFailure === 'permission' ||
                  locationFailure === 'prompt'
                "
                class="info-container"
              >
                <span class="material-icons icon"> location_off </span>
                <span class="text">
                  {{ 'MAIN.HOME.LOCATION_REQUIRED_CREATE_1' | translate }}
                  <i class="material-icons inline-icon"> home </i>
                  {{ 'MAIN.HOME.LOCATION_REQUIRED_CREATE_2' | translate }}
                </span>
                <span class="text">
                  {{ 'MAIN.HOME.LOCATION_SAFE' | translate }}
                </span>
                <span class="line"></span>
                <span class="text">
                  {{ 'MAIN.HOME.LOCATION_ENABLE' | translate }}
                </span>
                <button
                  *ngIf="locationFailure === 'prompt'"
                  class="enable-location-button"
                  (click)="askLocationPermission()"
                >
                  Enable Location
                </button>
              </div>
              <div *ngIf="locationFailure === 'general'" class="info-container">
                <span class="material-icons icon"> location_off </span>
                <span class="text">
                  {{ 'MAIN.HOME.LOCATION_ERROR' | translate }}
                </span>
                <span class="text">
                  {{ 'MAIN.HOME.LOCATION_REFRESH' | translate }}
                </span>
              </div>
            </ng-template>
          </ng-template>
        </div>

        <!-- CHAT ROOM TEST -->
        <spot-chat-join></spot-chat-join>

        <!-- Spots -->
        <div class="posts">
          <spot-infinite-scroll (scrolled)="onScroll()">
            <div *ngIf="spots.length > 0; else empty">
              <div *ngFor="let spot of spots">
                <spot-post [spot]="spot" [detailed]="false"></spot-post>
              </div>
            </div>
            <div #bottom class="empty-placeholder">
              <ng-template #empty>
                <!-- no spots in the area -->
                <div
                  *ngIf="noSpots && !loading && (showSpotsIndicator$ | async)"
                  class="empty-container"
                >
                  <div class="empty-image">
                    <span class="c1"></span>
                    <span class="c2"></span>
                    <span class="c3"></span>
                    <span class="material-icons icon"> travel_explore </span>
                  </div>
                  <span class="empty-text">
                    <span class="highlight">
                      {{ 'MAIN.HOME.FIRST_POST_1' | translate }}
                    </span>
                    {{ 'MAIN.HOME.FIRST_POST_2' | translate }}
                  </span>
                </div>
              </ng-template>
              <!-- There are no more spots -->
              <div
                *ngIf="
                  noSpots && spots.length !== 0 && (showSpotsIndicator$ | async)
                "
                class="empty-container"
              >
                <span class="material-icons icon"> done_all </span>
                <span class="text">
                  {{ 'MAIN.HOME.NO_MORE_POSTS' | translate }}
                </span>
              </div>
              <!-- Loading spots -->
              <div
                *ngIf="loading && (showSpotsIndicator$ | async)"
                class="empty-container"
              >
                <spot-spinner type="dot"></spot-spinner>
              </div>
            </div>
          </spot-infinite-scroll>
        </div>
      </div>

      <ng-template #noLocation>
        <div class="content">
          <!-- Location is just loading -->
          <div
            *ngIf="
              locationLoading && (showLocationIndicator$ | async);
              else enableLocation
            "
            class="info-container"
          >
            <spot-spinner type="dot"></spot-spinner>
            <span class="text">
              {{ 'MAIN.HOME.LOADING_LOCATION' | translate }}
            </span>
            <span class="text clickable" (click)="loadLocationBackground()">
              {{ 'MAIN.HOME.LOCATION_BACKGROUND_1' | translate }}
              <i class="material-icons inline-icon"> public </i>
              {{ 'MAIN.HOME.LOCATION_BACKGROUND_2' | translate }}
            </span>
          </div>
          <!-- Location was explicitly denied, an error occurred or not supported by browser -->
          <ng-template #enableLocation>
            <div *ngIf="locationFailure === 'browser'" class="info-container">
              <span class="material-icons icon"> location_off </span>
              <span class="text">
                {{ 'MAIN.HOME.LOCATION_BROWSER' | translate }}</span
              >
            </div>
            <div
              *ngIf="locationFailure === 'permission'"
              class="info-container"
            >
              <span class="material-icons icon"> location_off </span>
              <span class="text">
                {{ 'MAIN.HOME.LOCATION_REQUIRED_CREATE_1' | translate }}
                <i class="material-icons inline-icon"> home </i>
                {{ 'MAIN.HOME.LOCATION_REQUIRED_CREATE_2' | translate }}
              </span>
              <span class="text">
                {{ 'MAIN.HOME.LOCATION_SAFE' | translate }}
              </span>
              <span class="line"></span>
              <span class="text">
                {{ 'MAIN.HOME.LOCATION_ENABLE' | translate }}
              </span>
              <span class="text clickable" (click)="continueWithGlobal()">
                {{ 'MAIN.HOME.LOCATION_BACKGROUND_1' | translate }}
                <i class="material-icons inline-icon"> public </i>
                {{ 'MAIN.HOME.LOCATION_BACKGROUND_3' | translate }}
              </span>
            </div>
            <div *ngIf="locationFailure === 'general'" class="info-container">
              <span class="material-icons icon"> location_off </span>
              <span class="text">
                {{ 'MAIN.HOME.LOCATION_ERROR' | translate }}
              </span>
              <span class="text">
                {{ 'MAIN.HOME.LOCATION_REFRESH' | translate }}
              </span>
            </div>
          </ng-template>
        </div>
      </ng-template>
    </div>
  </div>
  <!-- User needs to be prompted for location -->
  <ng-template #prompt>
    <div class="content">
      <div class="info-container">
        <span class="material-icons icon"> location_off </span>
        <span class="text">
          {{ 'MAIN.HOME.LOCATION_REQUIRED_CREATE_1' | translate }}
          <i class="material-icons text-icon"> home </i>
          {{ 'MAIN.HOME.LOCATION_REQUIRED_CREATE_2' | translate }}
        </span>
        <span class="text clickable" (click)="continueWithGlobal()">
          {{ 'MAIN.HOME.LOCATION_BACKGROUND_1' | translate }}
          <i class="material-icons text-icon"> public </i>
          {{ 'MAIN.HOME.LOCATION_BACKGROUND_3' | translate }}
        </span>
        <span class="line"></span>
        <span class="text"> {{ 'MAIN.HOME.LOCATION_SAFE' | translate }} </span>
        <button
          class="enable-location-button"
          (click)="askLocationPermission()"
        >
          Enable Location
        </button>
      </div>
    </div>
  </ng-template>
</div>
